<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NovusMesh Server Manager</title>
  <style>
    :root {
      --bg: #0f172a;
      --bg-card: #1e293b;
      --bg-hover: #334155;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .app { display: flex; min-height: 100vh; }
    
    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--bg-card);
      border-right: 1px solid #334155;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: sticky;
      top: 0;
    }
    .logo {
      padding: 20px;
      font-size: 1.5rem;
      font-weight: bold;
      border-bottom: 1px solid #334155;
    }
    .logo span { color: var(--accent); }
    
    .server-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    .server-item {
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .server-item:hover { background: var(--bg-hover); }
    .server-item.active { background: var(--accent); }
    .server-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }
    .server-status.online { background: var(--success); }
    .server-status.offline { background: var(--danger); }
    .server-status.installed { background: var(--success); }
    .server-status.unknown { background: var(--warning); }
    
    .add-server-btn {
      margin: 10px;
      padding: 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
    }
    .add-server-btn:hover { background: var(--accent-hover); }
    
    /* Main Content */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .header {
      padding: 20px 30px;
      border-bottom: 1px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 1.5rem; }
    
    .content { padding: 30px; flex: 1; overflow-y: auto; }
    
    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .card-title { font-size: 1.1rem; font-weight: 600; }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: var(--bg-card);
      padding: 20px;
      border-radius: 12px;
    }
    .stat-value { font-size: 2rem; font-weight: bold; }
    .stat-label { color: var(--text-muted); font-size: 0.9rem; }
    
    /* Docker Table */
    .docker-table {
      width: 100%;
      border-collapse: collapse;
    }
    .docker-table th, .docker-table td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #334155;
    }
    .docker-table th { color: var(--text-muted); font-weight: 500; }
    
    /* Buttons */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-right: 5px;
    }
    .btn-primary { background: var(--accent); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-warning { background: var(--warning); color: black; }
    .btn-danger { background: var(--danger); color: white; }
    .btn:hover { opacity: 0.9; }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--bg-card);
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-title {
      font-size: 1.3rem;
      margin-bottom: 20px;
    }
    .form-group { margin-bottom: 15px; }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: var(--text-muted);
    }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 10px;
      background: var(--bg);
      border: 1px solid #334155;
      border-radius: 6px;
      color: var(--text);
    }
    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    /* Output Log */
    .output-log {
      background: #0a0a0a;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.85rem;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      color: #22c55e;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .empty-state h2 { margin-bottom: 10px; }
    
    /* Loading */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .footer {
      padding: 15px;
      border-top: 1px solid #334155;
      font-size: 0.8rem;
      text-align: center;
      background: var(--bg-card);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">Novus<span>Mesh</span></div>
      <div class="server-list" id="serverList">
        <!-- Server items rendered here -->
      </div>
      <button class="add-server-btn" onclick="showAddServerModal()">+ New Server</button>
      
      <div class="footer">
        <p>Developed by <a href="https://github.com/Ali7Zeynalli" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 500;">Ali Zeynalli</a></p>
        <div style="margin-top: 8px; display: flex; gap: 12px; justify-content: center;">
          <a href="https://github.com/Ali7Zeynalli" target="_blank" style="color: var(--text-muted); text-decoration: none;">GitHub</a>
          <a href="https://www.linkedin.com/in/ali7zeynalli/" target="_blank" style="color: var(--text-muted); text-decoration: none;">LinkedIn</a>
        </div>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main">
      <header class="header">
        <h1 id="serverTitle">Select Server</h1>
        <div>
          <button class="btn btn-primary" onclick="refreshStatus()" id="refreshBtn" style="display:none">‚Üª Refresh</button>
        </div>
      </header>
      
      <div class="content" id="mainContent">
        <div class="empty-state">
          <h2>No Server Selected</h2>
          <p>Select a server from the left or add a new one</p>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Add Server Modal -->
  <div class="modal" id="addServerModal">
    <div class="modal-content">
      <h2 class="modal-title">Add New Server</h2>
      <form id="addServerForm">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="serverName" required placeholder="Production Server">
        </div>
        <div class="form-group">
          <label>Host (IP)</label>
          <input type="text" id="serverHost" required placeholder="192.168.1.100">
        </div>
        <div class="form-group">
          <label>Port</label>
          <input type="number" id="serverPort" value="22">
        </div>
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="serverUsername" required placeholder="root">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="serverPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn" onclick="closeModal('addServerModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Add</button>
        </div>
      </form>
    </div>
  </div>
    <!-- Config Modal -->
    <div id="configModal" class="modal">
      <div class="modal-content">
        <h2 id="configTitle">‚öôÔ∏è Installation Configuration</h2>
        <p style="color: var(--text-muted); margin-bottom: 20px;">Customize your NovusMesh deployment.</p>
        
        <form id="installConfigForm" onsubmit="event.preventDefault(); confirmInstall();">
          <!-- Admin User -->
          <div class="form-group">
            <label>Admin Username</label>
            <input type="text" id="confAdminUser" value="admin" required>
          </div>
          
          <!-- Admin Pass -->
          <div class="form-group">
            <label>Admin Password <small>(Leave empty to auto-generate)</small></label>
            <input type="text" id="confAdminPass" placeholder="Auto-generate secure password">
          </div>
          
          <div style="border-top: 1px solid #333; margin: 15px 0;"></div>
          
          <!-- Admin Network IP -->
          <div class="form-group">
            <label>Admin Network Gateway IP</label>
            <input type="text" id="confVpnIp" value="10.99.0.1" required placeholder="e.g. 10.99.0.1">
            <small style="color: var(--text-muted)">The internal IP for the Admin Panel (wg0)</small>
          </div>

          <div style="border-top: 1px solid #333; margin: 15px 0;"></div>

          <!-- Database Config -->
          <h4 style="color: var(--accent); margin-bottom: 10px;">üóÑÔ∏è Database Settings</h4>
          
          <div class="form-group">
            <label>Database Name</label>
            <input type="text" id="confDbName" value="novusmesh" required>
          </div>
          
          <div class="form-group">
            <label>Database User</label>
            <input type="text" id="confDbUser" value="novusmesh" required>
          </div>
          
          <div class="form-group">
            <label>Database Password <small>(Leave empty to auto-generate)</small></label>
            <input type="text" id="confDbPass" placeholder="Auto-generate secure password">
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeConfigModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Start Installation üöÄ</button>
          </div>
        </form>
      </div>
    </div>
  
  <!-- Output Modal -->
  <div class="modal" id="outputModal">
    <div class="modal-content" style="max-width: 800px;">
      <h2 class="modal-title" id="outputTitle">Output</h2>
      
      <!-- New Credentials Section -->
      <div id="installCredentials" style="display: none; margin-bottom: 20px; background: #0f172a; padding: 15px; border-radius: 8px; border: 1px solid var(--accent);">
        <h3 style="color: var(--accent); margin-bottom: 10px;">üîë Security Keys</h3>
        <div style="display: grid; gap: 10px; font-family: monospace;">
          <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 5px;">
            <span style="color: var(--text-muted)">Admin User:</span>
            <span id="credUser" style="color: white">admin</span>
          </div>
          <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 5px;">
            <span style="color: var(--text-muted)">Admin Pass:</span>
            <span id="credPass" style="color: var(--success); font-weight: bold;">-</span>
          </div>
          <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 5px;">
            <span style="color: var(--text-muted)">API Key:</span>
            <span id="credApiKey" style="color: var(--warning)">-</span>
          </div>

          <div style="border-top: 1px solid #333; margin: 5px 0;"></div>
          <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 5px;">
            <span style="color: var(--text-muted)">DB Password:</span>
            <span id="credDbPass" style="color: #a855f7">-</span>
          </div>
          <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 5px;">
            <span style="color: var(--text-muted)">JWT Secret:</span>
            <span id="credJwt" style="color: #a855f7">-</span>
          </div>

        </div>
        <div style="margin-top: 10px; font-size: 0.8rem; color: var(--text-muted); text-align: center;">Copy and save these credentials.</div>
      </div>

      <!-- VPN Config Section -->
      <div id="vpnConfigSection" style="display: none; margin-bottom: 20px; background: #0f172a; padding: 15px; border-radius: 8px; border: 1px solid var(--accent);">
        <h3 style="color: var(--accent); margin-bottom: 10px;">üîí Admin VPN Configuration</h3>
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
          You <strong>MUST</strong> connect to this VPN to access the Admin Panel.
        </p>
        <textarea id="vpnConfigText" style="display:none;"></textarea>
        <button class="btn btn-success" onclick="downloadVpnConfig()" style="width: 100%;">üì• Download admin-vpn.conf</button>
      </div>

      <div class="output-log" id="outputLog"></div>
      <div class="modal-actions">
        <button class="btn btn-warning" onclick="downloadReport()" id="btnDownloadReport" style="display:none; margin-right: auto;">üì• Download Report</button>
        <button class="btn btn-primary" onclick="closeModal('outputModal')">Close</button>
      </div>
    </div>
  </div>

  </div>

  <script>
    // ... existing variables ...
    
    // START: Report Generation Logic
    function downloadReport() {
       const outputLog = document.getElementById('outputLog').textContent;
       const timestamp = new Date().toLocaleString();
       const status = outputLog.includes('[DONE] Completed successfully') ? 'SUCCESS' : 'FAILED';
       
       // Mask sensitive config for report
       const safeConfig = currentInstallParams ? JSON.parse(JSON.stringify(currentInstallParams)) : {};
       if (safeConfig.adminPassword) safeConfig.adminPassword = '***';
       if (safeConfig.dbPassword) safeConfig.dbPassword = '***';
       
       const reportHtml = `
<!DOCTYPE html>
<html>
<head>
 <title>NovusMesh Install Report</title>
 <style>
   body { font-family: monospace; background: #0f172a; color: #f1f5f9; padding: 20px; }
   .header { border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
   .status { font-weight: bold; color: ${status === 'SUCCESS' ? '#22c55e' : '#ef4444'}; }
   .log { background: #000; padding: 15px; border-radius: 8px; white-space: pre-wrap; border: 1px solid #333; }
   .meta { color: #94a3b8; font-size: 0.9em; margin-bottom: 5px; }
 </style>
</head>
<body>
 <div class="header">
   <h1>NovusMesh Installation Report</h1>
   <div class="meta">Date: ${timestamp}</div>
   <div class="meta">Status: <span class="status">${status}</span></div>
   <div class="meta">Server: ${selectedServer ? selectedServer.host : 'Unknown'}</div>
 </div>
 
 <h3>Configuration:</h3>
 <pre style="background:#1e293b; padding:10px; border-radius:4px;">${JSON.stringify(safeConfig, null, 2)}</pre>
 
 <h3>Full Installation Log:</h3>
 <div class="log">${outputLog}</div>
</body>
</html>`;

      const blob = new Blob([reportHtml], { type: 'text/html' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `novusmesh-report-${Date.now()}.html`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }
    // END: Report Generation Logic
    let servers = [];
    let selectedServer = null;
    let isProcessRunning = false;
    
    // Load servers on start
    async function loadServers() {
      try {
        const res = await fetch('/api/servers');
        servers = await res.json();
        renderServerList();
      } catch (err) {
        console.error('Error loading servers:', err);
      }
    }
    
    function renderServerList() {
      const list = document.getElementById('serverList');
      if (servers.length === 0) {
        list.innerHTML = '<div style="padding: 20px; color: var(--text-muted); text-align: center;">No Servers</div>';
        return;
      }
      
      list.innerHTML = servers.map(s => `
        <div class="server-item ${selectedServer?.id === s.id ? 'active' : ''}" onclick="selectServer('${s.id}')">
          <div class="server-status ${s.status || 'unknown'}"></div>
          <div>
            <div>${s.name}</div>
            <div style="font-size: 0.8rem; color: var(--text-muted)">${s.host}</div>
          </div>
        </div>
      `).join('');
    }
    
    async function selectServer(id) {
      selectedServer = servers.find(s => s.id === id);
      renderServerList();
      document.getElementById('serverTitle').textContent = selectedServer.name;
      document.getElementById('refreshBtn').style.display = 'inline-block';
      await refreshStatus();
    }
    
    async function refreshStatus() {
      if (!selectedServer) return;
      
      document.getElementById('mainContent').innerHTML = '<div class="empty-state"><div class="loading"></div><p>Loading...</p></div>';
      
      try {
        const res = await fetch(`/api/servers/${selectedServer.id}/status`);
        const status = await res.json();
        
        if (!res.ok) {
          throw new Error(status.error);
        }
        
        renderServerDashboard(status);
      } catch (err) {
        document.getElementById('mainContent').innerHTML = `
          <div class="card">
            <div style="color: var(--danger)">Error: ${err.message}</div>
            <button class="btn btn-primary" style="margin-top: 15px" onclick="refreshStatus()">Retry</button>
          </div>
        `;
      }
    }
    
    async function renderServerDashboard(status) {
      // Get docker containers
      let containers = [];
      try {
        const res = await fetch(`/api/servers/${selectedServer.id}/docker`);
        containers = await res.json();
      } catch {}
      
      const content = document.getElementById('mainContent');
      content.innerHTML = `
        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" style="color: ${status.isInstalled ? 'var(--success)' : 'var(--warning)'}">
              ${status.isInstalled ? '‚úì' : '‚úó'}
            </div>
            <div class="stat-label">${status.isInstalled ? 'Installed' : 'Not installed'}</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${containers.length}</div>
            <div class="stat-label">Docker Containers</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${status.freeSpace || 'N/A'}</div>
            <div class="stat-label">Free Disk</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${status.freeMemory || 'N/A'}</div>
            <div class="stat-label">Free RAM</div>
          </div>
        </div>
        
        <!-- Actions -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Actions</span>
          </div>
          <button class="btn btn-success" onclick="installServer('local')">üì¶ Install NovusMesh Server</button>
          <button class="btn btn-primary" onclick="updateServer()">üöÄ Update (Smart)</button>
          <button class="btn btn-info" onclick="migrateServer()" style="background: #8b5cf6">üóÑÔ∏è Database Migration Only</button>
          <button class="btn btn-warning" onclick="reinstallServer()">üîÑ Reinstall</button>
          <button class="btn btn-danger" onclick="uninstallNovusMesh()">üóëÔ∏è Uninstall NovusMesh</button>
          <button class="btn" onclick="deleteServer()" style="background: #333">‚ùå Delete Server</button>
        </div>
        
        <!-- Docker Containers -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Docker Containers</span>
            <div>
              <button class="btn btn-danger" onclick="bulkContainerAction('remove')" id="bulkRemoveContainers" style="display:none">üóëÔ∏è Delete Selected</button>
              <button class="btn btn-warning" onclick="bulkContainerAction('stop')" id="bulkStopContainers" style="display:none">‚èπ Stop</button>
              <button class="btn btn-primary" onclick="refreshStatus()">‚Üª</button>
            </div>
          </div>
          ${containers.length ? `
            <table class="docker-table">
              <thead>
                <tr>
                  <th><input type="checkbox" onchange="toggleAllContainers(this)"></th>
                  <th>Name</th><th>Status</th><th>Image</th><th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${containers.map(c => `
                  <tr>
                    <td><input type="checkbox" class="container-checkbox" value="${c.name}" onchange="updateBulkButtons()"></td>
                    <td>${c.name}</td>
                    <td style="color: ${c.status?.includes('Up') ? 'var(--success)' : 'var(--danger)'}">${c.status}</td>
                    <td style="color: var(--text-muted)">${c.image}</td>
                    <td>
                      <button class="btn btn-success" onclick="dockerAction('${c.name}', 'start')">‚ñ∂</button>
                      <button class="btn btn-warning" onclick="dockerAction('${c.name}', 'stop')">‚èπ</button>
                      <button class="btn btn-primary" onclick="dockerAction('${c.name}', 'restart')">üîÑ</button>
                      <button class="btn" onclick="dockerAction('${c.name}', 'logs')">üìã</button>
                      <button class="btn btn-danger" onclick="dockerAction('${c.name}', 'remove')">üóëÔ∏è</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          ` : '<p style="color: var(--text-muted)">No Docker containers found</p>'}
        </div>
        
        <!-- Docker Images -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Docker Images</span>
            <button class="btn" onclick="loadImages()">‚Üª</button>
          </div>
          <div id="imagesContainer"><p style="color: var(--text-muted)">Loading...</p></div>
        </div>
        
        <!-- Docker Volumes -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Docker Volumes</span>
            <button class="btn" onclick="loadVolumes()">‚Üª</button>
          </div>
          <div id="volumesContainer"><p style="color: var(--text-muted)">Loading...</p></div>
        </div>
        
        <!-- History -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">History</span>
          </div>
          ${selectedServer.history?.length ? `
            <ul style="list-style: none;">
              ${selectedServer.history.slice(0, 10).map(h => `
                <li style="padding: 8px 0; border-bottom: 1px solid #334155; display: flex; justify-content: space-between;">
                  <span>${h.action} ${h.container || ''}</span>
                  <span style="color: var(--text-muted)">${new Date(h.timestamp).toLocaleString()}</span>
                </li>
              `).join('')}
            </ul>
          ` : '<p style="color: var(--text-muted)">No History</p>'}
        </div>
      `;
      
      // Load images and volumes
      loadImages();
      loadVolumes();
    }
    
    
    
    let activeLogSource = null;

    async function dockerAction(container, action) {
      if (action === 'logs') {
        // Live Logging
        if (activeLogSource) activeLogSource.close();
        
        const output = document.getElementById('outputLog');
        output.textContent = 'Connecting to log stream...\n';
        document.getElementById('outputTitle').textContent = `Logs: ${container}`;
        document.getElementById('outputModal').classList.add('active');
        
        activeLogSource = new EventSource(`/api/servers/${selectedServer.id}/docker/logs/stream?container=${encodeURIComponent(container)}`);
        
        activeLogSource.onmessage = (e) => {
          try {
            const data = JSON.parse(e.data);
            if (data.text) {
              output.textContent += data.text;
              output.scrollTop = output.scrollHeight;
            }
            if (data.error) {
              output.textContent += `\n[ERROR] ${data.error}\n`;
            }
            if (data.done) {
              output.textContent += '\n[Stream closed]\n';
              activeLogSource.close();
              activeLogSource = null;
            }
          } catch (err) {
            console.error('Log parse error:', err);
          }
        };
        
        activeLogSource.onerror = (e) => {
          console.error('EventSource failed:', e);
          if (activeLogSource && activeLogSource.readyState === EventSource.CLOSED) {
             output.textContent += '\n[Connection lost]\n';
          }
          // Don't close immediately, let it retry or let user close
        };
        return;
      }

      // Normal Actions
      try {
        const res = await fetch(`/api/servers/${selectedServer.id}/docker/${action}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ container })
        });
        const data = await res.json();
        await refreshStatus();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }
    
    async function streamResponse(response, outputElement) {
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      let vpnConfigBuffer = '';
      let capturingVpnConfig = false;
      
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n\n');
        buffer = lines.pop();
        
        for (const line of lines) {
          if (line.startsWith('data: ')) {
            try {
              const data = JSON.parse(line.slice(6));
              if (data.text) {
                outputElement.textContent += data.text;
                outputElement.scrollTop = outputElement.scrollHeight;
                
                // Parse credentials
                const text = data.text;
                if (text.includes('ADMIN PASS:')) {
                   const match = text.match(/ADMIN PASS:\s+([^\n]+)/);
                   if (match) document.getElementById('credPass').textContent = match[1].trim();
                }
                if (text.includes('API_KEY:')) {
                   const match = text.match(/API_KEY:\s+([^\n]+)/);
                   if (match) document.getElementById('credApiKey').textContent = match[1].trim();
                }
                if (text.includes('DB_PASSWORD:')) {
                   const match = text.match(/DB_PASSWORD:\s+([^\n]+)/);
                   if (match) document.getElementById('credDbPass').textContent = match[1].trim();
                }
                if (text.includes('JWT_SECRET:')) {
                   const match = text.match(/JWT_SECRET:\s+([^\n]+)/);
                   if (match) document.getElementById('credJwt').textContent = match[1].trim();
                }


                // Parse VPN Config
                if (text.includes('BEGIN_VPN_CONFIG')) {
                  capturingVpnConfig = true;
                  vpnConfigBuffer = ''; 
                }
                if (capturingVpnConfig) {
                  // If just started, remove the marker
                  let content = text;
                  if (content.includes('BEGIN_VPN_CONFIG')) {
                     content = content.split('BEGIN_VPN_CONFIG')[1];
                  }
                  
                  if (content.includes('END_VPN_CONFIG')) {
                     vpnConfigBuffer += content.split('END_VPN_CONFIG')[0];
                     capturingVpnConfig = false;
                     
                     // Show download button
                     document.getElementById('vpnConfigText').value = vpnConfigBuffer.trim();
                     document.getElementById('vpnConfigSection').style.display = 'block';
                  } else {
                     vpnConfigBuffer += content;
                  }
                }
              }
              if (data.done) {
                // Final scan of the entire output for credentials to ensure nothing was missed due to chunking
                const fullText = outputElement.textContent;
                
                if (fullText.includes('ADMIN PASS:')) {
                   const match = fullText.match(/ADMIN PASS:\s+([^\n]+)/);
                   if (match) {
                     document.getElementById('credPass').textContent = match[1].trim();
                     document.getElementById('installCredentials').style.display = 'block';
                   }
                }
                if (fullText.includes('API_KEY:')) {
                   const match = fullText.match(/API_KEY:\s+([^\n]+)/);
                   if (match) document.getElementById('credApiKey').textContent = match[1].trim();
                }
                
                outputLog.textContent += '\n\n[DONE] ' + (data.success ? 'Completed successfully.' : 'Error occurred.');
                outputLog.scrollTop = outputLog.scrollHeight;
                isProcessRunning = false;
                
                // Show Report Button
                document.getElementById('btnDownloadReport').style.display = 'inline-block';
                if (data.success) {
                   loadServers(); // Refresh server status
                   alert('Installation complete! You can access the Admin Dashboard.');
                }
                return;
              }
              if (data.error) {
                outputElement.textContent += '\nError: ' + data.error;
              }
            } catch (e) { console.error(e); }
          }
        }
      }
      await loadServers();
    }

    async function reinstallServer() {
      if (isProcessRunning) {
        document.getElementById('outputModal').classList.add('active');
        return;
      }
      if (!confirm('WARNING: This will stop the server and reinstall it.\n\nDATA AND .ENV WILL BE PRESERVED.\n\nContinue?')) return;
      
      await installServer('local', true, false, false);
    }

    async function updateServer() {
      if (isProcessRunning) {
        document.getElementById('outputModal').classList.add('active');
        return;
      }
      if (!confirm('Server will be updated (files only).\n\nDatabase and config will remain untouched.\n\nContinue?')) return;
      
      await installServer('local', false, true, false);
    }

    async function migrateServer() {
      if (isProcessRunning) {
        document.getElementById('outputModal').classList.add('active');
        return;
      }
      if (!confirm('Only database migrations will run.\nFiles will not change.\n\nContinue?')) return;
      
      await installServer('local', false, false, true);
    }
    
    let currentInstallParams = null;

    function installServer(source, reinstall = false, update = false, migrateOnly = false) {
      if (!selectedServer) return alert('Please select a server first');
      
      currentInstallParams = { source, reinstall, update, migrateOnly };
      
      if (migrateOnly || update) {
        // Skip config for updates/migrations
        startInstallProcess();
      } else {
        // Show Config Modal for fresh install / reinstall
        document.getElementById('configModal').classList.add('active');
      }
    }
    
    function closeConfigModal() {
      document.getElementById('configModal').classList.remove('active');
    }

    function confirmInstall() {
      closeConfigModal();
      startInstallProcess();
    }

    async function startInstallProcess() {
      const { source, reinstall, update, migrateOnly } = currentInstallParams;

      if (!migrateOnly && !update) {
          // Confirm one last time
         if (!confirm(`Are you sure you want to install on ${selectedServer.host}? This might overwrite existing data.`)) return;
      }

      document.getElementById('outputModal').classList.add('active');
      const output = document.getElementById('outputLog');
      const title = document.getElementById('outputTitle');
      
        // Gather Config
        const config = {
          adminUsername: document.getElementById('confAdminUser').value,
          adminPassword: document.getElementById('confAdminPass').value,
          // networkName/Cidr removed as we only use Admin Network now
          vpnIp: document.getElementById('confVpnIp').value,
          dbName: document.getElementById('confDbName').value,
          dbUser: document.getElementById('confDbUser').value,
          dbPassword: document.getElementById('confDbPass').value
        };
      
      if (migrateOnly) title.textContent = 'Database Migration...';
      else if (update) title.textContent = 'Updating Server...';
      else if (reinstall) title.textContent = 'Reinstalling...';
      else title.textContent = 'Installing...';
      
      output.textContent = 'Starting...\n';
      
      // Reset credentials display
      document.getElementById('installCredentials').style.display = 'none';
      document.getElementById('credPass').textContent = '-';
      document.getElementById('credApiKey').textContent = '-';
      document.getElementById('credDbPass').textContent = '-';
      document.getElementById('credJwt').textContent = '-';
      document.getElementById('vpnConfigSection').style.display = 'none';
      document.getElementById('vpnConfigText').value = '';
      
      console.log('Sending install request with config:', config);
      isProcessRunning = true;
      try {
        const response = await fetch(`/api/servers/${selectedServer.id}/install`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            source, 
            reinstall, 
            update, 
            migrateOnly,
            ...config // Send config values
          })
        });
        
        console.log('Response received:', response.status);
        await streamResponse(response, output);
        await refreshStatus();
      } catch (err) {
        console.error('Install fetch error:', err);
        output.textContent += `\nError: ${err.message}`;
      } finally {
        isProcessRunning = false;
      }
    }

    function downloadVpnConfig() {
      const config = document.getElementById('vpnConfigText').value;
      if (!config) return alert('No config available');
      
      const blob = new Blob([config], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'admin-vpn.conf';
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }

    
    async function deleteServer() {
      if (!confirm('This server will be DELETED. Continue?')) return;
      
      await fetch(`/api/servers/${selectedServer.id}`, { method: 'DELETE' });
      selectedServer = null;
      await loadServers();
      document.getElementById('mainContent').innerHTML = '<div class="empty-state"><h2>No Server Selected</h2></div>';
      document.getElementById('serverTitle').textContent = 'Select Server';
      document.getElementById('refreshBtn').style.display = 'none';
    }
    
    // Modal functions
    function showAddServerModal() {
      document.getElementById('addServerModal').classList.add('active');
    }
    
    function closeModal(id) {
      if (id === 'outputModal') {
        if (activeLogSource) {
          activeLogSource.close();
          activeLogSource = null;
          console.log('Log stream closed by user');
        }
        
        if (isProcessRunning) {
          // Prevent accidental closing, but allow minimizing
          if (!confirm('Process continues in background. Do you want to hide this window?')) {
            return;
          }
        }
      }
      document.getElementById(id).classList.remove('active');
    }
    
    // Add server form
    document.getElementById('addServerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const server = {
        name: document.getElementById('serverName').value,
        host: document.getElementById('serverHost').value,
        port: parseInt(document.getElementById('serverPort').value) || 22,
        username: document.getElementById('serverUsername').value,
        password: document.getElementById('serverPassword').value
      };
      
      try {
        await fetch('/api/servers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(server)
        });
        closeModal('addServerModal');
        e.target.reset();
        await loadServers();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });
    
    // Load Docker Images
    async function loadImages() {
      const container = document.getElementById('imagesContainer');
      if (!container) return;
      
      try {
        const res = await fetch(`/api/servers/${selectedServer.id}/images`);
        const images = await res.json();
        
        if (images.length === 0) {
          container.innerHTML = '<p style="color: var(--text-muted)">No Images</p>';
          return;
        }
        
        container.innerHTML = `
          <div style="margin-bottom: 10px;">
            <button class="btn btn-danger" onclick="bulkDeleteImages()" id="bulkDeleteImages" style="display:none">üóëÔ∏è Delete Selected</button>
            <button class="btn btn-warning" onclick="pruneImages()">üßπ Prune Dangling Images</button>
          </div>
          <table class="docker-table">
            <thead><tr>
              <th><input type="checkbox" onchange="toggleAllImages(this)"></th>
              <th>ID</th><th>Repository</th><th>Tag</th><th>Size</th><th>Created</th><th></th>
            </tr></thead>
            <tbody>
              ${images.map(i => {
                const deleteId = i.repository === '<none>' ? i.id : `${i.repository}:${i.tag}`;
                return `
                <tr>
                  <td><input type="checkbox" class="image-checkbox" value="${deleteId}" onchange="updateBulkButtons()"></td>
                  <td style="color: var(--text-muted); font-family: monospace; font-size: 0.8rem">${i.id}</td>
                  <td>${i.repository}</td>
                  <td>${i.tag}</td>
                  <td>${i.size}</td>
                  <td style="color: var(--text-muted)">${i.created}</td>
                  <td><button class="btn btn-danger" onclick="deleteImage('${deleteId}')">üóëÔ∏è</button></td>
                </tr>
              `}).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        container.innerHTML = `<p style="color: var(--danger)">Error: ${err.message}</p>`;
      }
    }
    
    // Delete Docker Image
    async function deleteImage(name) {
      if (!confirm(`Delete image "${name}"?`)) return;
      
      try {
        await fetch(`/api/servers/${selectedServer.id}/images/${encodeURIComponent(name)}`, { method: 'DELETE' });
        loadImages();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }
    
    // Load Docker Volumes
    async function loadVolumes() {
      const container = document.getElementById('volumesContainer');
      if (!container) return;
      
      try {
        const res = await fetch(`/api/servers/${selectedServer.id}/volumes`);
        const volumes = await res.json();
        
        if (volumes.length === 0) {
          container.innerHTML = '<p style="color: var(--text-muted)">No Volumes</p>';
          return;
        }
        
        container.innerHTML = `
          <div style="margin-bottom: 10px;">
            <button class="btn btn-danger" onclick="bulkDeleteVolumes()" id="bulkDeleteVolumes" style="display:none">üóëÔ∏è Delete Selected</button>
          </div>
          <table class="docker-table">
            <thead><tr>
              <th><input type="checkbox" onchange="toggleAllVolumes(this)"></th>
              <th>Name</th><th>Driver</th><th></th>
            </tr></thead>
            <tbody>
              ${volumes.map(v => `
                <tr>
                  <td><input type="checkbox" class="volume-checkbox" value="${v.name}" onchange="updateBulkButtons()"></td>
                  <td>${v.name}</td>
                  <td style="color: var(--text-muted)">${v.driver}</td>
                  <td><button class="btn btn-danger" onclick="deleteVolume('${v.name}')">üóëÔ∏è</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        container.innerHTML = `<p style="color: var(--danger)">Error: ${err.message}</p>`;
      }
    }
    
    // Delete Docker Volume
    async function deleteVolume(name) {
      if (!confirm(`Delete volume "${name}"?`)) return;
      
      try {
        await fetch(`/api/servers/${selectedServer.id}/volumes/${name}`, { method: 'DELETE' });
        loadVolumes();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }
    
    // Uninstall NovusMesh completely
    async function uninstallNovusMesh() {
      if (!confirm('NovusMesh will be COMPLETELY REMOVED (containers, images, volumes, files). Continue?')) return;
      
      document.getElementById('outputTitle').textContent = 'Uninstalling NovusMesh';
      document.getElementById('outputLog').textContent = 'Starting...';
      document.getElementById('outputModal').classList.add('active');
      
      try {
        const res = await fetch(`/api/servers/${selectedServer.id}/uninstall`, { method: 'POST' });
        const data = await res.json();
        document.getElementById('outputLog').textContent = data.output || data.error;
        await loadServers();
        await refreshStatus();
      } catch (err) {
        document.getElementById('outputLog').textContent = 'Error: ' + err.message;
      }
    }
    
    // Bulk selection helpers
    function toggleAllContainers(master) {
      document.querySelectorAll('.container-checkbox').forEach(cb => cb.checked = master.checked);
      updateBulkButtons();
    }
    
    function toggleAllImages(master) {
      document.querySelectorAll('.image-checkbox').forEach(cb => cb.checked = master.checked);
      updateBulkButtons();
    }
    
    function toggleAllVolumes(master) {
      document.querySelectorAll('.volume-checkbox').forEach(cb => cb.checked = master.checked);
      updateBulkButtons();
    }
    
    function updateBulkButtons() {
      const containerCount = document.querySelectorAll('.container-checkbox:checked').length;
      const imageCount = document.querySelectorAll('.image-checkbox:checked').length;
      const volumeCount = document.querySelectorAll('.volume-checkbox:checked').length;
      
      const bulkRemoveContainers = document.getElementById('bulkRemoveContainers');
      const bulkStopContainers = document.getElementById('bulkStopContainers');
      const bulkDeleteImages = document.getElementById('bulkDeleteImages');
      const bulkDeleteVolumes = document.getElementById('bulkDeleteVolumes');
      
      if (bulkRemoveContainers) bulkRemoveContainers.style.display = containerCount > 0 ? 'inline-block' : 'none';
      if (bulkStopContainers) bulkStopContainers.style.display = containerCount > 0 ? 'inline-block' : 'none';
      if (bulkDeleteImages) bulkDeleteImages.style.display = imageCount > 0 ? 'inline-block' : 'none';
      if (bulkDeleteVolumes) bulkDeleteVolumes.style.display = volumeCount > 0 ? 'inline-block' : 'none';
    }
    
    async function bulkContainerAction(action) {
      const selected = [...document.querySelectorAll('.container-checkbox:checked')].map(cb => cb.value);
      if (selected.length === 0) return;
      
      if (!confirm(`Execute "${action}" on ${selected.length} containers?`)) return;
      
      for (const container of selected) {
        await dockerAction(container, action);
      }
      await refreshStatus();
    }
    
    async function bulkDeleteImages() {
      const selected = [...document.querySelectorAll('.image-checkbox:checked')].map(cb => cb.value);
      if (selected.length === 0) return;
      
      if (!confirm(`Delete ${selected.length} images?`)) return;
      
      for (const image of selected) {
        await deleteImage(image);
      }
      loadImages();
    }
    
    async function bulkDeleteVolumes() {
      const selected = [...document.querySelectorAll('.volume-checkbox:checked')].map(cb => cb.value);
      if (selected.length === 0) return;
      
      if (!confirm(`Delete ${selected.length} volumes?`)) return;
      
      for (const volume of selected) {
        await deleteVolume(volume);
      }
      loadVolumes();
    }
    
    // Prune dangling images
    async function pruneImages() {
      if (!confirm('Delete all dangling images?')) return;
      
      document.getElementById('outputTitle').textContent = 'Image Prune';
      document.getElementById('outputLog').textContent = 'Starting...';
      document.getElementById('outputModal').classList.add('active');
      
      try {
        const res = await fetch(`/api/servers/${selectedServer.id}/prune`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: 'images' })
        });
        const data = await res.json();
        document.getElementById('outputLog').textContent = data.output || data.error || 'Done';
        loadImages();
      } catch (err) {
        document.getElementById('outputLog').textContent = 'Error: ' + err.message;
      }
    }
    
    // Initialize
    loadServers();
  </script>
</body>
</html>
